import DatabaseService from './database.service.js';
import AuthService from './auth.service.js';

// ===== EJEMPLO DE LOGIN DE ADMINISTRADOR CON AUTH SERVICE =====

/**
 * Ejemplo de c√≥mo hacer login de administrador usando el AuthService
 */
async function ejemploLoginAdmin() {
    console.log('\nüîê === EJEMPLO DE LOGIN DE ADMINISTRADOR (CON AUTH SERVICE) ===');
    
    // Credenciales del administrador (desde tu db.json)
    const credenciales = {
        usuario: 'cperez',        // Usuario administrador
        password: 'hashed_password' // Contrase√±a (en producci√≥n ser√≠a hasheada)
    };
    
    try {
        console.log('üöÄ Usando AuthService para autenticaci√≥n...');
        
        // Usar el servicio de autenticaci√≥n para login de admin
        const resultado = await AuthService.autenticarAdmin(credenciales.usuario, credenciales.password);
        
        if (!resultado.success) {
            console.error('‚ùå Error en autenticaci√≥n:', resultado.message);
            return resultado;
        }
        
        console.log('‚úÖ LOGIN DE ADMINISTRADOR EXITOSO!');
        console.log('\nüìã Datos de sesi√≥n:');
        console.log('   üÜî Session ID:', resultado.data.sesion.sessionId);
        console.log('   üë§ Usuario:', resultado.data.usuario.usuario);
        console.log('   üé≠ Rol:', resultado.data.usuario.rol);
        console.log('   üè¢ Perfil:', resultado.data.usuario.perfil?.tipo);
        if (resultado.data.usuario.perfil?.empleado) {
            console.log('   üë®‚Äçüíº Empleado:', resultado.data.usuario.perfil.empleado.nombre);
            console.log('   üíº Puesto:', resultado.data.usuario.perfil.empleado.puesto);
        }
        console.log('   üîê Permisos:', resultado.data.permisos.join(', '));
        console.log('   ‚è∞ Fecha de login:', resultado.data.sesion.fechaCreacion);
        
        console.log('\nüéØ Operaciones disponibles para este administrador:');
        console.log('   ‚Ä¢ Gestionar usuarios (crear, editar, eliminar)');
        console.log('   ‚Ä¢ Gestionar tareas (asignar, modificar, completar)');
        console.log('   ‚Ä¢ Gestionar insumos (controlar stock, agregar)');
        console.log('   ‚Ä¢ Ver informaci√≥n de pacientes');
        console.log('   ‚Ä¢ Ver estad√≠sticas del sistema');
        
        // Demostrar verificaci√≥n de permisos
        console.log('\nüîç Verificando permisos espec√≠ficos:');
        const permisos = ['gestionar_usuarios', 'gestionar_tareas', 'ver_pacientes'];
        permisos.forEach(permiso => {
            const tienePermiso = AuthService.tienePermiso(resultado.data.usuario, permiso);
            console.log(`   ${tienePermiso ? '‚úÖ' : '‚ùå'} ${permiso}: ${tienePermiso ? 'S√ç' : 'NO'}`);
        });
        
        return resultado;
        
    } catch (error) {
        console.error('‚ùå Error en login de administrador:', error.message);
        return {
            success: false,
            message: error.message
        };
    }
}

/**
 * Ejemplo de logout de administrador usando AuthService
 */
async function ejemploLogoutAdmin(sessionId) {
    console.log('\nüö™ === EJEMPLO DE LOGOUT DE ADMINISTRADOR (CON AUTH SERVICE) ===');
    
    try {
        console.log('üîì Cerrando sesi√≥n usando AuthService...');
        console.log('   üìã Session ID:', sessionId);
        
        // Usar el servicio de autenticaci√≥n para cerrar sesi√≥n
        const resultado = AuthService.cerrarSesion(sessionId);
        
        if (resultado) {
            console.log('‚úÖ Sesi√≥n cerrada exitosamente');
            console.log('üîí Sesi√≥n invalidada en el servidor');
            
            return {
                success: true,
                message: 'Logout exitoso'
            };
        } else {
            console.log('‚ùå No se pudo cerrar la sesi√≥n (sesi√≥n no encontrada)');
            return {
                success: false,
                message: 'Sesi√≥n no encontrada'
            };
        }
        
    } catch (error) {
        console.error('‚ùå Error en logout:', error.message);
        return {
            success: false,
            message: error.message
        };
    }
}

/**
 * Ejemplo de verificaci√≥n de permisos usando AuthService
 */
async function verificarPermisoAdmin(sessionId, permisoRequerido) {
    console.log(`\nüîç === VERIFICANDO PERMISO: ${permisoRequerido} (CON AUTH SERVICE) ===`);
    
    try {
        // Obtener usuario actual por sesi√≥n
        const usuario = await AuthService.obtenerUsuarioActual(sessionId);
        
        if (!usuario) {
            console.log('‚ùå Sesi√≥n inv√°lida o expirada');
            return false;
        }
        
        // Verificar que sea administrador
        if (!AuthService.esAdministrador(usuario)) {
            console.log('‚ùå El usuario no es administrador');
            return false;
        }
        
        // Verificar permiso espec√≠fico
        if (!AuthService.tienePermiso(usuario, permisoRequerido)) {
            console.log(`‚ùå El administrador no tiene el permiso: ${permisoRequerido}`);
            return false;
        }
        
        console.log(`‚úÖ El administrador tiene el permiso: ${permisoRequerido}`);
        return true;
        
    } catch (error) {
        console.error('‚ùå Error verificando permisos:', error.message);
        return false;
    }
}

// Ejemplo de uso del servicio de base de datos
async function ejemploDeUso() {
    try {
        console.log('=== EJEMPLO DE USO DEL DATABASE SERVICE ===\n');

        // 1. Obtener todos los usuarios
        console.log('1. Obteniendo todos los usuarios:');
        const usuarios = await databaseService.getAllUsuarios();
        console.log(usuarios);
        console.log('\n');

        // 2. Obtener un usuario espec√≠fico
        console.log('2. Obteniendo usuario con ID 1:');
        const usuario = await databaseService.getUsuarioById(1);
        console.log(usuario);
        console.log('\n');

        // 3. Crear un nuevo empleado
        console.log('3. Creando un nuevo empleado:');
        const nuevoEmpleado = await databaseService.createEmpleado({
            nombre: 'Ana Garc√≠a',
            puesto: 'Recepcionista'
        });
        console.log('Empleado creado:', nuevoEmpleado);
        console.log('\n');

        // 4. Actualizar el empleado reci√©n creado
        console.log('4. Actualizando el empleado:');
        const empleadoActualizado = await databaseService.updateEmpleado(nuevoEmpleado.id, {
            puesto: 'Coordinadora de Recepci√≥n'
        });
        console.log('Empleado actualizado:', empleadoActualizado);
        console.log('\n');

        // 5. Obtener tareas por estado
        console.log('5. Obteniendo tareas pendientes:');
        const tareasPendientes = await databaseService.getTareasByEstado('pendiente');
        console.log(tareasPendientes);
        console.log('\n');

        // 6. Crear una nueva tarea
        console.log('6. Creando una nueva tarea:');
        const nuevaTarea = await databaseService.createTarea({
            descripcion: 'Revisi√≥n m√©dica general',
            empleadoId: 3,
            pacienteId: 2,
            estado: 'pendiente',
            fecha: '2025-09-20'
        });
        console.log('Tarea creada:', nuevaTarea);
        console.log('\n');

        // 7. Obtener usuario completo con detalles
        console.log('7. Obteniendo usuario completo con detalles:');
        const usuarioCompleto = await databaseService.getUsuarioCompleto(1);
        console.log(usuarioCompleto);
        console.log('\n');

        // 8. Obtener estad√≠sticas
        console.log('8. Obteniendo estad√≠sticas generales:');
        const estadisticas = await databaseService.getEstadisticas();
        console.log(estadisticas);
        console.log('\n');

        // 9. Actualizar stock de insumo
        console.log('9. Actualizando stock de insumo:');
        const insumoActualizado = await databaseService.updateStockInsumo(1, 180);
        console.log('Stock actualizado:', insumoActualizado);
        console.log('\n');

        // 10. Buscar paciente por DNI
        console.log('10. Buscando paciente por DNI:');
        const pacientePorDni = await databaseService.getPacienteByDni('30123456');
        console.log(pacientePorDni);
        console.log('\n');

        console.log('=== EJEMPLO COMPLETADO EXITOSAMENTE ===');

    } catch (error) {
        console.error('Error en el ejemplo:', error.message);
    }
}

// ==================== EJEMPLO COMPLETO DE FLUJO DE LOGIN ====================
/**
 * Ejemplo completo de flujo de login de administrador con AuthService
 */
async function ejemploCompletoLoginAdmin() {
    console.log('\nüöÄ === FLUJO COMPLETO DE LOGIN DE ADMINISTRADOR (CON AUTH SERVICE) ===\n');
    
    const databaseService = new DatabaseService();
    let sessionId = null;
    
    try {
        // 1. Login
        console.log('üìã PASO 1: LOGIN DE ADMINISTRADOR');
        const resultadoLogin = await ejemploLoginAdmin();
        
        if (!resultadoLogin.success) {
            console.log('‚ùå Login fallido, terminando flujo');
            return resultadoLogin;
        }
        
        sessionId = resultadoLogin.data.sesion.sessionId;
        console.log('‚úÖ Login exitoso, continuando con operaciones...\n');
        
        // 2. Verificar permisos espec√≠ficos
        console.log('üìã PASO 2: VERIFICACI√ìN DE PERMISOS');
        const permisos = ['gestionar_usuarios', 'gestionar_tareas', 'gestionar_insumos'];
        
        for (const permiso of permisos) {
            const tienePermiso = await verificarPermisoAdmin(sessionId, permiso);
            console.log(`   ${tienePermiso ? '‚úÖ' : '‚ùå'} ${permiso}: ${tienePermiso ? 'CONCEDIDO' : 'DENEGADO'}`);
        }
        console.log('');
        
        // 3. Verificar que la sesi√≥n sigue activa
        console.log('üìã PASO 3: VERIFICACI√ìN DE SESI√ìN ACTIVA');
        const sesionActiva = AuthService.obtenerSesion(sessionId);
        if (sesionActiva) {
            console.log('‚úÖ Sesi√≥n activa confirmada');
            console.log(`   üïê √öltima actividad: ${sesionActiva.ultimaActividad}`);
        } else {
            console.log('‚ùå Sesi√≥n no encontrada o expirada');
            return { success: false, message: 'Sesi√≥n expirada' };
        }
        console.log('');
        
        // 4. Realizar operaciones administrativas
        console.log('üìã PASO 4: OPERACIONES ADMINISTRATIVAS');
        
        // Crear un nuevo empleado
        console.log('üë®‚Äçüíº Creando nuevo empleado...');
        const nuevoEmpleado = await databaseService.createEmpleado({
            nombre: 'Ana Garc√≠a',
            puesto: 'Enfermera',
            telefono: '555-0123',
            email: 'ana.garcia@hospital.com',
            fechaIngreso: new Date().toISOString().split('T')[0]
        });
        console.log('‚úÖ Empleado creado:', nuevoEmpleado.nombre);
        
        // Crear un nuevo usuario para el empleado
        console.log('üë§ Creando usuario para el empleado...');
        const nuevoUsuario = await databaseService.createUsuario({
            usuario: 'agarcia',
            password: 'hashed_password',
            rolId: 2, // Rol de empleado
            perfilId: nuevoEmpleado.id,
            tipoPerfilId: 2 // Tipo empleado
        });
        console.log('‚úÖ Usuario creado:', nuevoUsuario.usuario);
        
        // Actualizar stock de un insumo
        console.log('üì¶ Actualizando stock de insumos...');
        const insumos = await databaseService.getAllInsumos();
        if (insumos.length > 0) {
            const insumoActualizar = insumos[0];
            const stockAnterior = insumoActualizar.stock;
            const nuevoStock = stockAnterior + 50;
            
            await databaseService.updateInsumo(insumoActualizar.id, {
                stock: nuevoStock
            });
            console.log(`‚úÖ Stock actualizado: ${insumoActualizar.nombre} (${stockAnterior} ‚Üí ${nuevoStock})`);
        }
        
        // Ver estad√≠sticas actualizadas
        console.log('üìä Obteniendo estad√≠sticas del sistema...');
        const estadisticas = await databaseService.getEstadisticas();
        console.log('‚úÖ Estad√≠sticas obtenidas:');
        console.log(`   üë• Usuarios: ${estadisticas.usuarios}`);
        console.log(`   üë®‚Äçüíº Empleados: ${estadisticas.empleados}`);
        console.log(`   üè• Pacientes: ${estadisticas.pacientes}`);
        console.log(`   üì¶ Insumos: ${estadisticas.insumos}`);
        console.log(`   üìã Tareas: ${estadisticas.tareas}`);
        
        // Ver estad√≠sticas de sesiones
        console.log('üìà Estad√≠sticas de sesiones activas:');
        const estadisticasSesiones = AuthService.obtenerEstadisticasSesiones();
        console.log(`   üîê Sesiones activas: ${estadisticasSesiones.total}`);
        console.log(`   üë• Por rol:`, estadisticasSesiones.porRol);
        console.log(`   üïê √öltima hora: ${estadisticasSesiones.ultimaHora}`);
        console.log('');
        
        // 5. Logout
        console.log('üìã PASO 5: LOGOUT');
        const resultadoLogout = await ejemploLogoutAdmin(sessionId);
        console.log(`${resultadoLogout.success ? '‚úÖ' : '‚ùå'} ${resultadoLogout.message}`);
        
        console.log('\nüéâ === FLUJO COMPLETO TERMINADO EXITOSAMENTE ===');
        
        return {
            success: true,
            message: 'Flujo completo de administrador ejecutado exitosamente',
            operaciones: {
                login: true,
                verificacionPermisos: true,
                verificacionSesion: true,
                creacionEmpleado: true,
                creacionUsuario: true,
                actualizacionStock: true,
                estadisticas: true,
                estadisticasSesiones: true,
                logout: true
            }
        };
        
    } catch (error) {
        console.error('‚ùå Error en flujo completo:', error.message);
        
        // Intentar cerrar sesi√≥n en caso de error
        if (sessionId) {
            console.log('üîÑ Intentando cerrar sesi√≥n debido al error...');
            AuthService.cerrarSesion(sessionId);
        }
        
        return {
            success: false,
            message: `Error en flujo completo: ${error.message}`
        };
    }
}

// Ejecutar el ejemplo si este archivo se ejecuta directamente
if (import.meta.url === `file://${process.argv[1]}`) {
    // Puedes cambiar qu√© ejemplo ejecutar:
    // ejemploDeUso();           // Ejemplo general
    // ejemploLoginAdmin();      // Solo login
    ejemploCompletoLoginAdmin(); // Flujo completo de login
}

export { 
    ejemploDeUso, 
    ejemploLoginAdmin, 
    ejemploLogoutAdmin, 
    verificarPermisoAdmin, 
    ejemploCompletoLoginAdmin 
};